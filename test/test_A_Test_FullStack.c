#include <stdlib.h>
#include <stdbool.h>
#include <string.h>
#include "unity.h"

#include "Filo.h"
#include "LCSF_Transcoder.h"
#include "LCSF_Validator.h"
#include "LCSF_Bridge_Test.h"
#include "LCSF_Desc_Test.h"
#include "Test_Main.h"
#include "mock_MemAlloc.h"

// *** Constants ***
#define FILO_SIZE 20
#define BUFF_SIZE 255
#define ARRAY_SIZE 5
#define PROTOCOL_NB 1

// *** Private functions prototypes ***
static void *calloc_Callback(uint32_t size, int num_calls);
static void *malloc_Callback(uint32_t size, int num_calls);
static bool process_error_Callback(uint8_t error_code, int num_calls);
static bool send_Callback(const uint8_t *pBuffer, uint16_t buffSize);

// *** Descriptors ***
static const lcsf_trnscdr_init_desc_t init_trnscdr = {
    send_Callback,
    FILO_SIZE,
    BUFF_SIZE,
};

static const lcsf_validator_init_desc_t init_vldtr = {
    FILO_SIZE,
    PROTOCOL_NB,
};

static const lcsf_validator_protocol_desc_t test_prot_desc = {
    LCSF_TEST_PROTOCOL_ID,
    &LCSF_Test_ProtDesc,
    LCSF_Bridge_TestReceive,
};

// *** Private global vars ***
static void *memPtr[64];
static int memIdx;
static int send_num_calls;

// *** Model data ***
#ifdef LCSF_SMALL
// Error messages
static const uint8_t err_unknown_prot_msg[] = {0xFF, 0x00, 0x02, 0x00, 0x01, 0x01, 0x01, 0x01, 0x00};
static const uint8_t err_unknown_cmd_msg[] = {0xFF, 0x00, 0x02, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01};
static const uint8_t err_unknown_att_msg[] = {0xFF, 0x00, 0x02, 0x00, 0x01, 0x01, 0x01, 0x01, 0x02};
static const uint8_t err_too_many_att_msg[] = {0xFF, 0x00, 0x02, 0x00, 0x01, 0x01, 0x01, 0x01, 0x03};
static const uint8_t err_missing_att_msg[] = {0xFF, 0x00, 0x02, 0x00, 0x01, 0x01, 0x01, 0x01, 0x04};
static const uint8_t err_wrong_data_type_msg[] = {0xFF, 0x00, 0x02, 0x00, 0x01, 0x01, 0x01, 0x01, 0x05};
// Wrong messages
static const uint8_t bad_prot_id_msg[] = {0x21, 0x00, 0x00};
static const uint8_t bad_cmd_id_msg[] = {0x55, 0x4c, 0x00};
static const uint8_t bad_att_id_msg[] = {0x55, 0x03, 0x06, // CC1
 0x00, 0x01, 0x00, // SA1
 0x01, 0x02, 0x00, 0x00, // SA2
 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, // SA3
 0x03, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, // SA4
 0x04, 0x01, 0x00, // SA5
 0x48, 0x01, 0x00 // Wrong att
};
static const uint8_t extra_att_msg[] = {0x55, 0x00, 0x01, 0x00, 0x01, 0x00};
static const uint8_t missing_att_msg[] = {0x55, 0x03, 0x05, // CC1
 0x00, 0x01, 0x00, // SA1
 0x01, 0x02, 0x00, 0x00, // SA2
 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, // SA3
 0x03, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, // SA4
 0x05, 0x01, 0x00 // SA6
};
static const uint8_t bad_data_type_msg[] = {0x55, 0x03, 0x05, // CC1
 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, // SA1
 0x01, 0x02, 0x00, 0x00, // SA2
 0x02, 0x04, 0x00, 0x00, 0x00, 0x00, // SA3
 0x03, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, // SA4
 0x04, 0x01, 0x00 // SA5
};
// Test messages
static const uint8_t sc1_msg[] = {0x55, 0x00, 0x00};
static const uint8_t sc2_msg[] = {0x55, 0x01, 0x00};
static const uint8_t sc3_msg[] = {0x55, 0x02, 0x00};
static uint8_t cc1_msg[] = {
0x55, 0x03, 0x09, // CC1
0x00, 0x01, 0x01, // SA1
0x01, 0x02, 0xD1, 0x07, // SA2
0x02, 0x04, 0xa1, 0x86, 0x01, 0x00, // SA3
0x03, 0x05, 0x06, 0x05, 0x04, 0x03, 0x02, // SA4
0x04, 0x04, 0x43, 0x70, 0x63, 0x00, // SA5
0x05, 0x01, 0x04, // SA6
0x07, 0x04, 0xf0, 0x49, 0x02, 0x00, // SA8
0x08, 0x05, 0x02, 0x03, 0x04, 0x05, 0x06, // SA9
0x09, 0x05, 0x51, 0x62, 0x76, 0x6d, 0x00 // SA10
};
static uint8_t cc2_msg[] = {
0x55, 0x04, 0x09, // CC2
0x00, 0x01, 0x00, // SA1
0x01, 0x02, 0xD0, 0x07, // SA2
0x02, 0x04, 0xa0, 0x86, 0x01, 0x00, // SA3
0x03, 0x05, 0x05, 0x04, 0x03, 0x02, 0x01, // SA4
0x04, 0x04, 0x42, 0x6f, 0x62, 0x00, // SA5
0x05, 0x01, 0x03, // SA6
0x07, 0x04, 0xef, 0x49, 0x02, 0x00, // SA8
0x08, 0x05, 0x01, 0x02, 0x03, 0x04, 0x05, // SA9
0x09, 0x05, 0x50, 0x61, 0x75, 0x6c, 0x00 // SA10
};
static uint8_t cc3_msg_rx[] = {
0x55, 0x05, 0x07, // CC3
0x00, 0x01, 0x00, // SA1
0x01, 0x02, 0x00, 0x00, // SA2
0x02, 0x04, 0xef, 0x49, 0x6a, 0x43, // SA3
0x03, 0x05, 0x55, 0xaa, 0x55, 0xaa, 0x55, // SA4
0x04, 0x10, 0x46, 0x6f, 0x77, 0x6c, 0x65, 0x72, 0x2d, 0x4e, 0x6f, 0x72, 0x64, 0x68, 0x65, 0x69, 0x6d, 0x00, // SA5
0x06, 0x02, 0x00, 0x00, // SA7
0x08, 0x05, 0x00, 0xff, 0x00, 0xff, 0x00, // SA9
};
static uint8_t cc3_msg_tx[] = {
0x55, 0x05, 0x07, // CC3
0x00, 0x01, 0xff, // SA1
0x01, 0x02, 0xff, 0xff, // SA2
0x02, 0x04, 0xee, 0x49, 0x6a, 0x43, // SA3
0x03, 0x05, 0x54, 0xa9, 0x54, 0xa9, 0x54, // SA4
0x04, 0x10, 0x45, 0x6e, 0x76, 0x6b, 0x64, 0x71, 0x2c, 0x4d, 0x6e, 0x71, 0x63, 0x67, 0x64, 0x68, 0x6c, 0x00, // SA5
0x06, 0x02, 0xff, 0xff, // SA7
0x08, 0x05, 0xff, 0xfe, 0xff, 0xfe, 0xff, // SA9
};
static uint8_t cc4_msg[] = {
0x55, 0x06, 0x03, // CC4
0x00, 0x01, 0x12, // SA1
0x8a, 0x02, // CA1
0x00, 0x01, 0x24, // CA1_SA1
0x01, 0x02, 0x10, 0x20, // CA1_SA2
0x8b, 0x02, // CA2
0x00, 0x01, 0xaa, // CA2_SA1
0x8b, 0x01, // CA2_CA3
0x8a, 0x01, // CA3_CA4
0x03, 0x05, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f // CA4_SA4
};
static uint8_t cc5_msg[] = {
0x55, 0x07, 0x03, // CC5
0x01, 0x02, 0x11, 0x02, // SA2
0x8a, 0x02, // CA1
0x00, 0x01, 0x23, // CA1_SA1
0x01, 0x02, 0x0f, 0x20, // CA1_SA2
0x8b, 0x02, // CA2
0x00, 0x01, 0xa9, // CA2_SA1
0x8b, 0x01, // CA2_CA3
0x8a, 0x01, // CA3_CA4
0x03, 0x05, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e // CA4_SA4
};
static uint8_t cc6_msg_rx[] = {
0x55, 0x08, 0x02, // CC6
0x03, 0x05, 0x41, 0x02, 0x81, 0x0a, 0xc0, // SA4
0x8a, 0x03, // CA9
0x00, 0x01, 0x23, // CA9_SA1
0x01, 0x02, 0x61, 0x2c, // CA9_SA2
0x02, 0x04, 0x21, 0x14, 0x00, 0xa2 // CA9_SA3
};
static uint8_t cc6_msg_tx[] = {
0x55, 0x08, 0x02, // CC6
0x03, 0x05, 0x40, 0x01, 0x80, 0x09, 0xbf, // SA4
0x8a, 0x03, // CA9
0x00, 0x01, 0x22, // CA9_SA1
0x01, 0x02, 0x60, 0x2c, // CA9_SA2
0x02, 0x04, 0x20, 0x14, 0x00, 0xa2 // CA9_SA3
};

#else
// Error messages
static const uint8_t err_unknown_prot_msg[] = {
0xFF, 0xFF, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x01, 0x00, 0x00
};
static const uint8_t err_unknown_cmd_msg[] = {
0xFF, 0xFF, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x01, 0x00, 0x01
};
static const uint8_t err_unknown_att_msg[] = {
0xFF, 0xFF, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x01, 0x00, 0x02
};
static const uint8_t err_too_many_att_msg[] = {
0xFF, 0xFF, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x01, 0x00, 0x03
};
static const uint8_t err_missing_att_msg[] = {
0xFF, 0xFF, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x01, 0x00, 0x04
};
static const uint8_t err_wrong_data_type_msg[] = {
0xFF, 0xFF, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x00, 0x01, 0x00, 0x05
};
// Wrong messages
static const uint8_t bad_prot_id_msg[] = {0x21, 0x00, 0x00, 0x00, 0x00, 0x00};
static const uint8_t bad_cmd_id_msg[] = {0x55, 0x00, 0x4c, 0x00, 0x00, 0x00};
static const uint8_t bad_att_id_msg[] = {0x55, 0x00, 0x03, 0x00, 0x06, 0x00, // CC1
 0x00, 0x00, 0x01, 0x00, 0x00, // SA1
 0x01, 0x00, 0x02, 0x00, 0x00, 0x00, // SA2
 0x02, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, // SA3
 0x03, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // SA4
 0x04, 0x00, 0x01, 0x00, 0x00, // SA5
 0x48, 0x00, 0x01, 0x00, 0x00 // Wrong att
};
static const uint8_t extra_att_msg[] = {0x55, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00};
static const uint8_t missing_att_msg[] = {0x55, 0x00, 0x03, 0x00, 0x05, 0x00, // CC1
 0x00, 0x00, 0x01, 0x00, 0x00, // SA1
 0x01, 0x00, 0x02, 0x00, 0x00, 0x00, // SA2
 0x02, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, // SA3
 0x03, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // SA4
 0x05, 0x00, 0x01, 0x00, 0x00 // SA6
};
static const uint8_t bad_data_type_msg[] = {0x55, 0x00, 0x03, 0x00, 0x05, 0x00, // CC1
 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, // SA1
 0x01, 0x00, 0x02, 0x00, 0x00, 0x00, // SA2
 0x02, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, // SA3
 0x03, 0x00, 0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // SA4
 0x04, 0x00, 0x01, 0x00, 0x00 // SA5
};
// Test messages
static const uint8_t sc1_msg[] = {0x55, 0x00, 0x00, 0x00, 0x00, 0x00};
static const uint8_t sc2_msg[] = {0x55, 0x00, 0x01, 0x00, 0x00, 0x00};
static const uint8_t sc3_msg[] = {0x55, 0x00, 0x02, 0x00, 0x00, 0x00};
static uint8_t cc1_msg[] = {
0x55, 0x00, 0x03, 0x00, 0x09, 0x00, // CC1
0x00, 0x00, 0x01, 0x00, 0x01, // SA1
0x01, 0x00, 0x02, 0x00, 0xd1, 0x07, // SA2
0x02, 0x00, 0x04, 0x00, 0xa1, 0x86, 0x01, 0x00, // SA3
0x03, 0x00, 0x05, 0x00, 0x06, 0x05, 0x04, 0x03, 0x02, // SA4
0x04, 0x00, 0x04, 0x00, 0x43, 0x70, 0x63, 0x00, // SA5
0x05, 0x00, 0x01, 0x00, 0x04, // SA6
0x07, 0x00, 0x04, 0x00, 0xf0, 0x49, 0x02, 0x00, // SA8
0x08, 0x00, 0x05, 0x00, 0x02, 0x03, 0x04, 0x05, 0x06, // SA9
0x09, 0x00, 0x05, 0x00, 0x51, 0x62, 0x76, 0x6d, 0x00 // SA10
};
static uint8_t cc2_msg[] = {
0x55, 0x00, 0x04, 0x00, 0x09, 0x00, // CC2
0x00, 0x00, 0x01, 0x00, 0x00, // SA1
0x01, 0x00, 0x02, 0x00, 0xD0, 0x07, // SA2
0x02, 0x00, 0x04, 0x00, 0xa0, 0x86, 0x01, 0x00, // SA3
0x03, 0x00, 0x05, 0x00, 0x05, 0x04, 0x03, 0x02, 0x01, // SA4
0x04, 0x00, 0x04, 0x00, 0x42, 0x6f, 0x62, 0x00, // SA5
0x05, 0x00, 0x01, 0x00, 0x03, // SA6
0x07, 0x00, 0x04, 0x00, 0xef, 0x49, 0x02, 0x00, // SA8
0x08, 0x00, 0x05, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, // SA9
0x09, 0x00, 0x05, 0x00, 0x50, 0x61, 0x75, 0x6c, 0x00 // SA10
};
static uint8_t cc3_msg_rx[] = {
0x55, 0x00, 0x05, 0x00, 0x07, 0x00, // CC3
0x00, 0x00, 0x01, 0x00, 0x00, // SA1
0x01, 0x00, 0x02, 0x00, 0x00, 0x00, // SA2
0x02, 0x00, 0x04, 0x00, 0xef, 0x49, 0x6a, 0x43, // SA3
0x03, 0x00, 0x05, 0x00, 0x55, 0xaa, 0x55, 0xaa, 0x55, // SA4
0x04, 0x00, 0x10, 0x00, 0x46, 0x6f, 0x77, 0x6c, 0x65, 0x72, 0x2d, 0x4e, 0x6f, 0x72, 0x64, 0x68, 0x65, 0x69, 0x6d, 0x00, // SA5
0x06, 0x00, 0x02, 0x00, 0x00, 0x00, // SA7
0x08, 0x00, 0x05, 0x00, 0x00, 0xff, 0x00, 0xff, 0x00, // SA9
};
static uint8_t cc3_msg_tx[] = {
0x55, 0x00, 0x05, 0x00, 0x07, 0x00, // CC3
0x00, 0x00, 0x01, 0x00, 0xff, // SA1
0x01, 0x00, 0x02, 0x00, 0xff, 0xff, // SA2
0x02, 0x00, 0x04, 0x00, 0xee, 0x49, 0x6a, 0x43, // SA3
0x03, 0x00, 0x05, 0x00, 0x54, 0xa9, 0x54, 0xa9, 0x54, // SA4
0x04, 0x00, 0x10, 0x00, 0x45, 0x6e, 0x76, 0x6b, 0x64, 0x71, 0x2c, 0x4d, 0x6e, 0x71, 0x63, 0x67, 0x64, 0x68, 0x6c, 0x00, // SA5
0x06, 0x00, 0x02, 0x00, 0xff, 0xff, // SA7
0x08, 0x00, 0x05, 0x00, 0xff, 0xfe, 0xff, 0xfe, 0xff, // SA9
};
static uint8_t cc4_msg[] = {
0x55, 0x00, 0x06, 0x00, 0x03, 0x00, // CC4
0x00, 0x00, 0x01, 0x00, 0x12, // SA1
0x0a, 0x80, 0x02, 0x00, // CA1
0x00, 0x00, 0x01, 0x00, 0x24, // CA1_SA1
0x01, 0x00, 0x02, 0x00, 0x10, 0x20, // CA1_SA2
0x0b, 0x80, 0x02, 0x00, // CA2
0x00, 0x00, 0x01, 0x00, 0xaa, // CA2_SA1
0x0b, 0x80, 0x01, 0x00, // CA2_CA3
0x0a, 0x80, 0x01, 0x00, // CA3_CA4
0x03, 0x00, 0x05, 0x00, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f // CA4_SA4
};
static uint8_t cc5_msg[] = {
0x55, 0x00, 0x07, 0x00, 0x03, 0x00, // CC5
0x01, 0x00, 0x02, 0x00, 0x11, 0x02, // SA2
0x0a, 0x80, 0x02, 0x00, // CA1
0x00, 0x00, 0x01, 0x00, 0x23, // CA1_SA1
0x01, 0x00, 0x02, 0x00, 0x0f, 0x20, // CA1_SA2
0x0b, 0x80, 0x02, 0x00, // CA2
0x00, 0x00, 0x01, 0x00, 0xa9, // CA2_SA1
0x0b, 0x80, 0x01, 0x00, // CA2_CA3
0x0a, 0x80, 0x01, 0x00, // CA3_CA4
0x03, 0x00, 0x05, 0x00, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e // CA4_SA4
};
static uint8_t cc6_msg_rx[] = {
0x55, 0x00, 0x08, 0x00, 0x02, 0x00, // CC6
0x03, 0x00, 0x05, 0x00, 0x41, 0x02, 0x81, 0x0a, 0xc0, // SA4
0x0a, 0x80, 0x03, 0x00, // CA9
0x00, 0x00, 0x01, 0x00, 0x23, // CA9_SA1
0x01, 0x00, 0x02, 0x00, 0x61, 0x2c, // CA9_SA2
0x02, 0x00, 0x04, 0x00, 0x21, 0x14, 0x00, 0xa2 // CA9_SA3
};
static uint8_t cc6_msg_tx[] = {
0x55, 0x00, 0x08, 0x00, 0x02, 0x00, // CC6
0x03, 0x00, 0x05, 0x00, 0x40, 0x01, 0x80, 0x09, 0xbf, // SA4
0x0a, 0x80, 0x03, 0x00, // CA9
0x00, 0x00, 0x01, 0x00, 0x22, // CA9_SA1
0x01, 0x00, 0x02, 0x00, 0x60, 0x2c, // CA9_SA2
0x02, 0x00, 0x04, 0x00, 0x20, 0x14, 0x00, 0xa2 // CA9_SA3
};
#endif

// *** Private Functions ***
static void print_buffer(const uint8_t *p1, const uint8_t *p2, uint16_t buffSize) {
    printf(" Diff at: \n");
    for (int idx = 0; idx < buffSize; idx++) {
        if (p1[idx] != p2[idx]) {
            printf("idx: %d, val: %d %d\n", idx, p1[idx], p2[idx]);
        }
    }
}

// *** Callback Functions ***
static void *calloc_Callback(uint32_t size, int num_calls) {
    memPtr[memIdx] = calloc(size,1);
    return memPtr[memIdx++];
}

static void *malloc_Callback(uint32_t size, int num_calls) {
    memPtr[memIdx] = malloc(size);
    return memPtr[memIdx++];
}

static bool send_Callback(const uint8_t *pBuffer, uint16_t buffSize) {
    bool res = false;
    switch (send_num_calls) {
        case 0:
            res = (memcmp(pBuffer, sc1_msg, buffSize) == 0);
            if (!res) {
                printf("Bad SC1 received.\n");
                print_buffer(pBuffer, sc1_msg, buffSize);
            } else {
                printf("Correct SC1 received.\n");
            }
        break;

        case 1:
            res = (memcmp(pBuffer, sc3_msg, buffSize) == 0);
            if (!res) {
                printf("Bad SC3 received.\n");
                print_buffer(pBuffer, sc3_msg, buffSize);
            } else {
                printf("Correct SC3 received.\n");
            }
        break;

        case 2:
            res = (memcmp(pBuffer, cc1_msg, buffSize) == 0);
            if (!res) {
                printf("Bad CC1 received.\n");
                print_buffer(pBuffer, cc1_msg, buffSize);
            } else {
                printf("Correct CC1 received.\n");
            }
        break;

        case 3:
            res = (memcmp(pBuffer, cc3_msg_tx, buffSize) == 0);
            if (!res) {
                printf("Bad CC3 received.\n");
                print_buffer(pBuffer, cc3_msg_tx, buffSize);
            } else {
                printf("Correct CC3 received.\n");
            }
        break;

        case 4:
            res = (memcmp(pBuffer, cc4_msg, buffSize) == 0);
            if (!res) {
                printf("Bad CC4 received.\n");
                print_buffer(pBuffer, cc4_msg, buffSize);
            } else {
                printf("Correct CC4 received.\n");
            }
        break;

        case 5:
            res = (memcmp(pBuffer, cc6_msg_tx, buffSize) == 0);
            if (!res) {
                printf("Bad CC6 received.\n");
                print_buffer(pBuffer, cc6_msg_tx, buffSize);
            } else {
                printf("Correct CC6 received.\n");
            }
        break;

        case 6:
            res = (memcmp(pBuffer, err_unknown_prot_msg, buffSize) == 0);
            if (!res) {
                printf("Bad unknown protocol error received.\n");
                print_buffer(pBuffer, err_unknown_prot_msg, buffSize);
            } else {
                printf("Correct unknown protocol error received.\n");
            }
        break;

        case 7:
            res = (memcmp(pBuffer, err_unknown_cmd_msg, buffSize) == 0);
            if (!res) {
                printf("Bad unknown command error received.\n");
                print_buffer(pBuffer, err_unknown_cmd_msg, buffSize);
            } else {
                printf("Correct unknown command error received.\n");
            }
        break;

        case 8:
            res = (memcmp(pBuffer, err_unknown_att_msg, buffSize) == 0);
            if (!res) {
                printf("Bad unknown attribute error received.\n");
                print_buffer(pBuffer, err_unknown_att_msg, buffSize);
            } else {
                printf("Correct unknown attribute error received.\n");
            }
        break;

        case 9:
            res = (memcmp(pBuffer, err_too_many_att_msg, buffSize) == 0);
            if (!res) {
                printf("Bad too many attribute error received.\n");
                print_buffer(pBuffer, err_too_many_att_msg, buffSize);
            } else {
                printf("Correct too many attribute error received.\n");
            }
        break;

        case 10:
            res = (memcmp(pBuffer, err_missing_att_msg, buffSize) == 0);
            if (!res) {
                printf("Bad missing attribute error received.\n");
                print_buffer(pBuffer, err_missing_att_msg, buffSize);
            } else {
                printf("Correct missing attribute error received.\n");
            }
        break;

        case 11:
            res = (memcmp(pBuffer, err_wrong_data_type_msg, buffSize) == 0);
            if (!res) {
                printf("Bad wrong data type error received.\n");
                print_buffer(pBuffer, err_wrong_data_type_msg, buffSize);
            } else {
                printf("Correct wrong data type error received.\n");
            }
        break;

        default:
        break;
    }
    send_num_calls++;
    return res;
}

// *** Public Functions ***
void setUp(void) {
    // Declare callback
    MemAllocCalloc_StubWithCallback(calloc_Callback);
    MemAllocMalloc_StubWithCallback(malloc_Callback);
    // Test init modules error
    TEST_ASSERT_FALSE(LCSF_TranscoderInit(NULL));
    TEST_ASSERT_FALSE(LCSF_ValidatorInit(NULL));
    TEST_ASSERT_FALSE(LCSF_ValidatorAddProtocol(0, NULL));
    // Test init modules valid
    TEST_ASSERT_TRUE(LCSF_TranscoderInit(&init_trnscdr));
    TEST_ASSERT_TRUE(LCSF_ValidatorInit(&init_vldtr));
    TEST_ASSERT_TRUE(LCSF_ValidatorAddProtocol(0, &test_prot_desc));
    TEST_ASSERT_TRUE(LCSF_Bridge_TestInit(FILO_SIZE));
    TEST_ASSERT_TRUE(Test_MainInit());
}

void tearDown(void) {
    // Free allocated memory
    for (int idx = 0; idx < memIdx; idx++) {
        free(memPtr[idx]);
    }
    memIdx = 0;
}

void test_Test_Main_Execute(void) {
#ifdef LCSF_SMALL
    printf("Smaller LCSF representation is in use.\n");
#else
    printf("Regular LCSF representation is in use.\n");
#endif
    // Test function error cases
    TEST_ASSERT_FALSE(LCSF_TranscoderReceive(sc1_msg, sizeof(sc1_msg)));
    TEST_ASSERT_FALSE(LCSF_TranscoderReceive(cc1_msg, sizeof(cc1_msg)));
    // Test valid cases
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(sc2_msg, sizeof(sc2_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(sc3_msg, sizeof(sc3_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(cc2_msg, sizeof(cc2_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(cc3_msg_rx, sizeof(cc3_msg_rx)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(cc5_msg, sizeof(cc5_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(cc6_msg_rx, sizeof(cc6_msg_rx)));
    // Test bad message cases
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(bad_prot_id_msg, sizeof(bad_prot_id_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(bad_cmd_id_msg, sizeof(bad_cmd_id_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(bad_att_id_msg, sizeof(bad_att_id_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(extra_att_msg, sizeof(extra_att_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(missing_att_msg, sizeof(missing_att_msg)));
    TEST_ASSERT_TRUE(LCSF_TranscoderReceive(bad_data_type_msg, sizeof(bad_data_type_msg)));
}